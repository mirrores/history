//全局ajax获取评论参数
var getCommentJson;
//登录后调整换页面
var login_redirect='/user/home';

function made() {
    alert('made');
}

//Request请求方法
var Request=function(json){
    var _this=this;
    this.url=json.url;
    this.method=json.method?json.method:'get';
    this.dataType=json.dataType?json.dataType:'html';
    this.data=json.data?json.data:'&ajax=true';
    this.onRequest=function(){
        if(json.onRequest){
            json.onRequest();
        }
    }
    //成功请求回调方法
    this.onSuccess=function(data){
        if(json.onSuccess){
            json.onSuccess(data);
        }
    };
    //错误访问
    this.onError=function(jqXHR, textStatus, errorThrown){
        alert('很抱歉，数据请求失败，请求地址：'+_this.url+'，请刷新网页重试！');
    };
    this.send=function(){
        _this.onRequest();
        $.ajax({
            url: _this.url,
            type:_this.method,
            processData: false,
            data: _this.data,
            success: _this.onSuccess,
            error:_this.onError,
            dataType:_this.dataType
        });
    }
}

//candyForm表单提交
var CandyForm=function(form_id,json){
    
    //定义在子类中调用的变量名称
    var _this=this;
    //是否成功
    this.is_success=false;
    //错误提示
    this.error_string='';
    //form id
    this.formId=form_id;
    //form表单对象
    this.form=$('#'+form_id);
    this.data_type=json.data_type?json.data_type:'html';
    //facebox确认按钮
    this.faceboxButton=null;
    //错误提示方式
    this.errorDisplayType=json.errorDisplayType?json.errorDisplayType:'formError';
    
    //提交方式
    this.method=json.method?json.method:'post';
    
    //显示loading
    this.loading=json.loading?json.loading:false;
    
    //提交地址
    this.action=json.action?json.action:this.form.attr('action');
    
    //提交按钮
    this.submitButton=json.submitButton?$('#'+json.submitButton):$("#submit_button");
    
    //没有定义的按钮寻找facebox确认按钮
    if(this.submitButton.length==0){
        var $aui_buttons=$("#aui_buttons");
        this.faceboxButton=$aui_buttons.find(".aui_state_highlight");
    }

    //按钮原来文字
    this.old_text=this.submitButton.attr('value');
    
    //发送状态提示的文字
    this.textSuccess=json.textSuccess?json.textSuccess:'成功发送',
    this.textSending=json.textSending?json.textSending:'发送中';
    this.textError=json.textError?json.textError:'重试',
    //提交前方法
    this.before_submit=function(){
        if(json.before){
            json.before();
        }
        //状态提示符
        if($('#candy_form_loading').length>0){
            $("#candy_form_loading").html('<img src="/static/images/loading.gif">');
        }
        else{
            _this.form.after('<div id="candy_form_loading" style="padding:10px"><img src="/static/images/loading.gif"></div>');  
        }
        //提示框
        if($('#candy_form_err').length>0){
            $("#candy_form_err").hide();
        }
        else{
            _this.form.after('<div id="candy_form_err" class="candy_form_err" style="display:none"></div>');  
        }
        
        //按钮暂时不可用，并显示发送状态
        //faceboxButton按钮
        if(_this.faceboxButton){
            _this.faceboxButton.attr('disabled',true);
            _this.faceboxButton.html(_this.textSending);
        }
        else{
            _this.submitButton.attr('disabled',true);
            _this.submitButton.attr('value',_this.textSending);
        }

    }
    
    //提交过程能够中
    this.submitting=function(){
    
    }
    //回执方法
    this.success=function(data){
        
        //json格式
        if(_this.data_type=='json'){
            if(data.status==1){
                _this.is_success=true;
            }
            else{
                _this.error_string=data.error;
            }
        }
        //html格式
        else if(_this.data_type=='html'){
            if (data.indexOf("err#")>=0){
                _this.error_string=data.replace("err#","");
            } 
            else{
                _this.is_success=true;
            }
        }
        else{
            _this.is_success=true;
        }
        
        //处理成功信息
        if(_this.is_success==true){
            
            if(_this.faceboxButton){
                _this.faceboxButton.attr('disabled',false);
                _this.faceboxButton.html(_this.textSuccess);
            }
            else{
                _this.submitButton.attr('disabled',false);
                _this.submitButton.attr('value',_this.textSuccess);
            }
            
            $("#candy_form_loading").html('');
            $('#candy_form_err').hide();
            //成功后调整到某一个页面
            if(json.redirect){
                window.location.href=json.redirect;
                return false;
            }
            //成功后操作
            if(json.callback){
                json.callback(data);
            }
        }
        //请求失败提示
        else{
            $("#candy_form_loading").html('');
            if(_this.faceboxButton){
                _this.faceboxButton.attr('disabled',false);
                _this.faceboxButton.html(_this.textError);
            }
            else{
                _this.submitButton.attr('disabled',false);
                _this.submitButton.attr('value',_this.textError);
            }
            //在表单底部提示
            if(_this.errorDisplayType=='formError'){
                $("#candy_form_err").html(_this.error_string);
                $('#candy_form_err').fadeIn(400);
                setTimeout(function(){
                    $('#candy_form_err').fadeOut(400);
                },3000);
            }
            //弹出窗口
            else if(_this.errorDisplayType=='alert'){
                alert(_this.error_string);
            }
            else if(_this.errorDisplayType=='dialogbox'){
                errorAlert(_this.error_string);
            }
            else{
            }
        }
    }
    //请求错误
    this.error=function(xhr){
        $("#candy_form_loading").html('');
        if(xhr.readyState==4 && xhr.status==0){
            $("#candy_form_err").html('很抱歉，请求超时，请重试或与管理员联系!');
        }
        
        if(xhr.readyState==4 && xhr.status==200){
            $("#candy_form_err").html('程序出错，请重试或与管理员联系!');
        }
        else{
            $("#candy_form_err").html('错误的返回数据:readyState:'+xhr.readyState+',xhr.status:'+xhr.status);
        }
        
        $("#candy_form_loading").html('');
        $('#candy_form_err').fadeIn(400);
        _this.submitButton.attr('disabled',false);
        _this.submitButton.attr('value',_this.textError);
    
    }   
    //提交方法
    this.send=function(){
        var options={
            beforeSubmit:_this.before_submit,
            success:_this.success,
            error:_this.error,
            dataType:_this.data_type,
            url:_this.action,
            type:_this.method
        };
        _this.form.ajaxSubmit(options);
    };

};
//Facebox对话框
var Facebox=function(json){
    var _this=this;
    this.box=null,
    this.padding=json.padding?json.padding:'10px';
    this.minWidth=json.minWidth?json.minWidth:null,
    this.minHeight=json.minHeight?json.minHeight:null,
    this.follow=json.follow?json.follow:null,	
    this.lock=json.lock?json.lock:false,	
    this.top=json.top?json.top:'40%';
    this.left=json.left?json.left:'45%';
    this.icon=json.icon?json.icon:false;
    this.title=json.title?json.title:'消息提示';
    this.button=json.button?json.button:null;
    this.okValue=json.okValue?json.okValue:'确定';
    this.cancelVal=json.cancelVal?json.cancelVal:'取消';
    this.width=json.width?json.width:'320px';
    this.height=json.height?json.height:'70px';
    this.message=json.message?json.message:null;
    this.url=json.url?json.url:null;
    this.time=json.time?json.time:null;
    //点击确定执行的方法
    this.ok=json.ok?json.ok:null;
    //默认有取消操作
    this.cancel=json.cancel?json.cancel:true;
    //隐藏关闭按钮
    this.cancel=this.cancel=='hidden'?null:this.cancel;
    //打开方法
    this.show=function(){
        _this.box=art.dialog({
            padding: _this.padding,
            id:'my_dialogbox',
            title:_this.title,
            top:_this.top,
            left:_this.left,
            icon:_this.icon,
            width:_this.width,
            height:_this.height,
            minWidth:_this.minWidth,
            minHeight:_this.minHeight,
            button:_this.button,
            ok:_this.ok,
            lock:_this.lock,
            okValue:_this.okValue,
            cancel:_this.cancel,
            cancelVal:_this.cancelVal,
            time:_this.time,
            content: '<img src="/static/images/user/loading6.gif">'
        });
        //定义了url装载页面
        if(_this.message){
            //询问框
            _this.box.content(_this.message); 
        }
        else if(_this.url){
            var list = new Request({
                url: _this.url,
                method: 'get',
                onSuccess: function(data){
                    _this.box.content(data);
                }
            });
            list.send();
        }
        else{
            _this.box.content('您想做什么呢？');
        }
    }
    
    this.close=function(){
        _this.box.close();
    }
}

//发送站内信
function msgform(){
    new Facebox({
        title: '填写报名信息',
        url: '/user/msgform',
        cancelFunction:true,
        ok: function(){
            //提交表单
            new CandyForm('msg_form', {
                callback:function(data){
                }
            }).send();
        }
    }).show();
}

//成功提示框
function okAlert(message){
    new Facebox({
        title: '操作提示',
        icon:'succeed',
        cancelVal:'关闭',
        message:message,
        time:3
    }).show();
}

//成功提示框
function errorAlert(message){
    new Facebox({
        title: '操作提示',
        icon:'error',
        cancelVal:'关闭',
        message:message
    }).show();
}

//artDialog用户登录窗口
function loginForm(redirect){
    login_redirect=redirect;
    new Facebox({
        title:'登录帐号',
        top:'50%',
        left:'45%',
        width:'450px',
        cancel:'hidden',
        url: '/user/login'
    }).show();
}

//facebook询问框
var candyConfirm=function(json){
    var _this=this;
    this.textSuccess=json.textSuccess?json.textSuccess:'发送成功',
    this.textSending=json.textSending?json.textSending:'发送中';
    this.open=function(){
        new Facebox({
            title: json.title?json.title:'删除确认！',
            message:json.message?json.message:'确定要删除该内容吗？注意删除后不可再恢复！',
            icon:json.icon?json.icon:'question',
            ok: function(){
                var $aui_buttons=$("#aui_buttons");
                var faceboxButton=$aui_buttons.find(".aui_state_highlight");
                faceboxButton.html(_this.textSending);
                new Request({
                    url: json.url,
                    method: 'post',
                    onSuccess: function(){
                        faceboxButton.html(_this.textSuccess);
                        if(json.removeDom){
                            candyDel(json.removeDom);
                        }
                        if(json.redirect){
                            window.location.href=json.redirect;
                        }
                        if(json.callback){
                            json.callback();
                        }
                    }
                }).send();
            }
        }).show();
    }
}

//参加活动
function signForm(eid){
    new Facebox({
        title: '填写报名信息',
        url: '/event/signForm?eid='+eid,
        width: 450,
        ok: function(){
            //提交表单
            new CandyForm('sign_form', {
                textSuccess:'发送成功',
                callback:function(data){
                    window.location.reload();
                }
            }).send();
        return false;
    }
    }).show();
}

//取消报名
function cancel_sign(eid){
    new candyConfirm({
        message:'您确定要取消本次活动报名吗？',
        url: '/event/cancelSign?eid='+eid,
        callback:function(){
            window.location.reload();
        }
    }).open();
}
                    
//删除
function candyDel(id){
    var removeObj=$('#'+id);
    document.getElementById(id).style.backgroundColor='#FCB4C6';
    removeObj.fadeOut(400);
    setTimeOut(function(){
        removeObj.remove();
    },500)
}

//删除
function candyOk(id){
    var removeObj=$('#'+id);
    document.getElementById(id).style.backgroundColor='#A2E3A2';
    removeObj.fadeOut(400);
    setTimeOut(function(){
        removeObj.remove();
    },500)
}

//登录
function loginsub() {
    var loginForm = new CandyForm('userLogin', {
        textSending: '登录中',
        textError: '重试',
        loading:true,
        textSuccess: '登录成功',
        callback: function(id){
            window.location.href=login_redirect;
        }
    });
    loginForm.send();

}

//发布评论
function post_comment(json){
    var cmtForm = new CandyForm(json.form, {
        submitButton:'cmt_submit',
        textSending: '发送中',
        textError: '发布失败',
        loading:true,
        textSuccess: '发表成功',
        callback: function(id){
            //获取最新评论
            get_comment({
                'page':'last',
                'scrollTo':false,
                'uid':false,
                'query':json.query,
                'getUrl':json.getUrl
            });
            //清空之前内容
            $('#comment_form').attr('action', '/comment/post');
            showPrompt('发表评论 积分+1',1500);
            var quote_box=document.getElementById('quote_box');
            document.getElementById('quote_id').value='';
            quote_box.innerHTML='';
            quote_box.style.display='none';
            ueditor.setContent('');
        }
    });
    if(!ueditor.hasContents()){
        ueditor.setContent('');
    }
    ueditor.sync();
    cmtForm.send();
}

//关注
function markUser(mark_id){
    var markButton=document.getElementById('markButton');
    markButton.disabled=true;
    markButton.value='发送中';
    new Request({
        url: '/user/markUser?mark_id='+mark_id,
        method: 'get',
        onSuccess: function(data){
            if(data=='互关注'){
                markButton.className='markMutual';
                markButton.value='互关注';
                markButton.title='取消关注';
            }
            else if(data=='互不关注'){
                markButton.className='markUser';
                markButton.value='关注';
                markButton.title='点击关注';
            }
            else if(data=='已关注'){
                markButton.className='marked';
                markButton.value='已关注';
                markButton.title='取消关注';
            }
            else if(data=='关注了我'){
                markButton.className='markMe';
                markButton.value='关注';
                markButton.title='点击关注';
            }
            else{
            }
            markButton.disabled=false;
        }
    }).send();
}

//user
function userDetail(uid){
     new Facebox({
        submitValue:false,
        submitFunction:false,
        cancelVal:'关闭',
        cancelFunction:function(){},
        url: '/user/userDetail?id='+uid,
        width:500
    }).show();
}

//判断变量是否定义
function is_defined(obj){
    if(typeof(obj)!='undefined' && obj!=false){
        return true;
    }
    else{
        return false;
    }
}

//评论翻页
function cmtpage(page){
    var new_json=getCommentJson;
    new_json.page=page;
    new_json.scrollTo='get_comment_list';
    get_comment(new_json);
}

//获取论坛评论
function get_comment(json){
    var query=json.query;
    
    //滚动到屏幕某一位置
    if(is_defined(json.scrollTo)){
        scrollTo(json.scrollTo,500)
    }
    //指定某一页
    if(is_defined(json.page)){
        query += '&page='+json.page;
    }
    
    if(is_defined(json.uid)){
        query += '&reply='+json.uid;
    }
    
    //异步获取
    new Request({
        url: json.getUrl,
        method: 'get',
        data:query,
        onSuccess: function(data){
            $('#get_comment_list').html(data);
        }
    }).send();
}

//修改评论
function modify_comment(id){
    scrollTo('comment_form',300);
    var cmt_submit=$('#cmt_submit');
    cmt_submit.attr('value','保存修改');
    cmt_submit.attr('disabled',true);
    cmt_submit.addClass('button_disabled');
    ueditor.setContent('<span style="color:#999">正在载入，请稍候...</span>');
    new Request({
        url: '/comment/modifycontent?id='+id,
        method: 'get',
        onSuccess: function(data){
            ueditor.setContent(''+data+'');
            cmt_submit.attr('disabled',false);
            cmt_submit.removeClass('button_disabled');
            cmt_submit.addClass('button_blue');
        }
    }).send();
}

//引用引用
function quote_comment(id){
    var quote_box=document.getElementById('quote_box');
    var user = $('#comment_author_'+id).text();
    var postdate = $('#comment_postdate_'+id).text();
    quote_box.style.display='block';
    quote_box.innerHTML='<span><b>引用</b> '+user+"&nbsp;"+postdate+'&nbsp;发布的评论&nbsp;</span><img src="/static/images/cancel.gif" style="vertical-align: middle" onclick="cancel_quote()" title="取消引用">';
    document.getElementById('quote_id').value=id;
    scrollTo('comment_form',500)
}
//取消引用
function cancel_quote(){
    var quote_box=document.getElementById('quote_box');
    document.getElementById('quote_id').value='';
    quote_box.innerHTML='';
    quote_box.style.display='none';
}

//滚动到指定位置
function scrollTo(id,speed){
    $.scrollTo('#'+id,speed);
}

//实时显示剩余字数
function countChar(textobj,spanName,maxlength)
{
    var obj=document.getElementById(textobj);
    var obj_count=obj.value.length;
    if(obj_count<=maxlength){
        document.getElementById(spanName).innerHTML=maxlength-obj_count;
    }
    else{
        obj.value = obj.value.substring(0,maxlength);
    }
}

//加入收藏夹
function AddFavorite(sURL, sTitle) {
    try {
        window.external.addFavorite(sURL, sTitle);
    } catch (e) {
        try {
            window.sidebar.addPanel(sTitle, sURL, "");
        } catch (e) {
            alert("加入收藏失败，请使用Ctrl+D进行添加");
        }
    }
}   

//感兴趣投票
function interested(event_id,interested_num){
    var interested_box=document.getElementById('interested_box');
    interested_box.innerHTML='提交中...';
    new Request({
        url: '/event/interested?id='+event_id,
        method: 'post',
        onSuccess: function(data){
            if(data=='ed'){
                alert('您已经透过票啦~');
                interested_box.innerHTML='感兴趣('+interested_num+')';
            }
            else{
                interested_box.innerHTML=data;
            }
        }
    }).send();
}